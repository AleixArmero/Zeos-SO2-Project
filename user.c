#include <libc.h>
#include <slabs.h>

#define PLAYER_COLOR 0x3
#define GROUND 0x0
#define ENEMY_COLOR 0x2
#define WIN_COLOR 0xA
#define BG_WIN 0x1
#define BG_LOSE 0x1
#define LOSE_COLOR 0xC
#define RESPONSE_DELAY 50
#define ENEMY_DELAY 80

sem_t *sem_update_screen, *sem_screen_updated, *sem_move_agent;
int last_position[4][2];
int last_enemy = 0;
char key;
enum state {PLAY, WIN, LOSE} game_state = PLAY;
int block_time = 0;
int move_player = 0;
int move_enemy = 0;
int add_block = 0;

char map[25][80][2] = {
{{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},{'[', 0x0A},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{' ', 0x00},{'#', 0x0F},},
{{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},{'#', 0x0F},},
};

void *print_screen (int agent[][2]) {
  clrscr((char *)map);
  
  changeColor(PLAYER_COLOR, 0x0);
  gotoXY(agent[0][0], agent[0][1]);
  write(1, "P", 1);
  
  changeColor(ENEMY_COLOR, 0x0);
  gotoXY(agent[1][0], agent[1][1]);
  write(1, "E", 1);
  gotoXY(agent[2][0], agent[2][1]);
  write(1, "E", 1);
  gotoXY(agent[3][0], agent[3][1]);
  write(1, "E", 1);
  
  while(1) {  
    semWait (sem_update_screen);
    
    if (last_position[0][0] != agent[0][0] || last_position[0][1] != agent[0][1]) {
      changeColor(GROUND, 0x0); 
      gotoXY(last_position[0][0], last_position[0][1]);
      write(1, " ", 1);
      changeColor(PLAYER_COLOR, 0x0);
      gotoXY(agent[0][0], agent[0][1]);
      write(1, "P", 1);
    }
    
    if (game_state == WIN) {
      changeColor(WIN_COLOR, BG_WIN);
      gotoXY (30,12);
      write (1, "*************\n", 14);
      gotoXY (30,13);
      write (1, "* YOU WIN ! *\n", 14);
      gotoXY (30,14);
      write (1, "*************\n", 14);
      exit();
    }
    
    for (int i = 1; i <= 3; i++) 
      if (last_position[i][0] != agent[i][0] || last_position[i][1] != agent[i][1]) {
        changeColor(GROUND, 0x0);
        gotoXY(last_position[i][0], last_position[i][1]);
        write(1, " ", 1);
        changeColor(ENEMY_COLOR, 0x0);
        gotoXY(agent[i][0], agent[i][1]);
        write(1, "E", 1);
      }
    
    if (game_state == LOSE) {
      changeColor(LOSE_COLOR, BG_LOSE);
      gotoXY (30,12);
      write (1, "***************\n", 16);
      gotoXY (30,13);
      write (1, "* GAME OVER ! *\n", 16);
      gotoXY (30,14);
      write (1, "***************\n", 16);
      exit();
    }
  
    semSignal (sem_screen_updated);
  }
}

void *move_agent (int s[][2]) {
  int px, py, ex, ey, targetx, targety;
 
  while (1) {
	  semWait (sem_move_agent);
	  semWait (sem_screen_updated);
	  
	  last_position[0][0] = s[0][0]; last_position[0][1] = s[0][1];
	  last_position[1][0] = s[1][0]; last_position[1][1] = s[1][1];
	  last_position[2][0] = s[2][0]; last_position[2][1] = s[2][1];
	  last_position[3][0] = s[3][0]; last_position[3][1] = s[3][1];
	  
	  if (move_player == 1)  {
		  px = s[0][0];
  		py = s[0][1];
	  
	    switch (key)
	  	{
	  	  case 'w':
	  	    if (map[py-1][px][0] != '#')
	  	 	    py--;
	  	  	break;
	  	  case 'a':
	  		  if (map[py][px-1][0] != '#')
	  		    px--;
	  		  break;
	  	  case 's':
	  		  if (map[py+1][px][0] != '#')
	  	      py++;
	  		  break;
        case 'd':
	  		  if (map[py][px+1][0] != '#')
	  		    px++;
	  		  break;
	    }
	    s[0][0] = px;
	    s[0][1] = py;
	    move_player = 0;
	  }
	  else if (move_enemy == 1) {
	    int i = last_enemy+1;
  	  ex = s[i][0];
	    ey = s[i][1];
	        
      if (ex - s[0][0] > 0)
        targetx = ex-1;
      else
        targetx = ex+1;
         
      if (ey - s[0][1] > 0)
        targety = ey-1;
      else
        targety = ey+1;
       
      if (map[targety][targetx][0] == '#' && map[targety][ex][0] != '#')
        targetx = ex;
      else if (map[targety][targetx][0] == '#' && map[ey][targetx][0] != '#')
        targety = ey;
      else if (map[targety][targetx][0] == '#') {
        targetx = ex;
        targety = ey;
      }
      
      last_enemy = (last_enemy+1)%3;
      move_enemy = 0;
	      
      s[i][0] = targetx;
      s[i][1] = targety;
    }
    
    for (int j = 1; j <= 3; j++)
      if (s[j][0] == s[0][0] && s[j][1] == s[0][1]) {
        game_state = LOSE;
        break;
      }
      else if (map[s[0][1]][s[0][0]][0] == '[')
	      game_state = WIN;
	   
	  semSignal (sem_update_screen);
	}
}

void *key_read (void *s) {
	
	while (1) {
	  if (getKey((char *)s, RESPONSE_DELAY) > -1) {
  	  move_player = 1;
	    semSignal (sem_move_agent);  
	  }
	}
}

void init_agent(int *agent) {
	int i = 0;
	agent[i*2] = 1;
	agent[i*2 + 1] = 23;
	
	i++;
	
	agent[i*2] = 5;
	agent[i*2 + 1] = 5;
	
	i++;
	
	agent[i*2] = 20;
	agent[i*2 + 1] = 23;
	
	i++;
	
	agent[i*2] = 75;
	agent[i*2 + 1] = 10;
}

void *test (void *s)
{
  // nothing to do here
  return s;
}

void __attribute__ ((__section__(".text.exit")))
  exit_from_thread (void)
{
  exit();
}

int __attribute__ ((__section__(".text.main")))
  main(void)
{
    /* Next line, tries to move value 0 to CR3 register. This register is a privileged one, and so it will raise an exception */
     /* __asm__ __volatile__ ("mov %0, %%cr3"::"r" (0) ); */

  struct free_chunks f;
  struct slab_t s;
  int *enemy_time;

  init_chunks (&f);
  create_slab (&f, &s, sizeof(int), sizeof(int));
  enemy_time = (int *) allocate_mem (&s);

  sem_move_agent = semCreate(0);
  sem_update_screen = semCreate(1);
  sem_screen_updated = semCreate(0); 
  
  int *agent = (int *) memRegGet(1);
  init_agent(agent);
  
  create_thread ((void *) print_screen, 1, (void *) agent);
  create_thread (key_read, 1, (void *) &key);
  create_thread ((void *) move_agent, 1, (void *) agent);  

  *enemy_time = 0;

  // Threat to test return without exit
  int v;
  create_thread (test, 1, &v);

  while(1) {
    if (gettime() >= *enemy_time + ENEMY_DELAY) {
      *enemy_time = gettime();
      move_enemy = 1;
      semSignal(sem_move_agent);
    }
  }
	
} 
